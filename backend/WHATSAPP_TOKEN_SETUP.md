# WhatsApp Business API - Automatic Token Refresh Setup

This guide explains how to set up automatic token refresh for WhatsApp Business API to avoid manual token renewal every few hours.

## ğŸ” Problem
- WhatsApp Business API access tokens expire every 1-2 hours
- Manual renewal from Meta Developer Console is required
- Production downtime when tokens expire

## ğŸ’¡ Solution
Implement automatic token refresh using long-lived refresh tokens and background scheduling.

## ğŸ“‹ Prerequisites
1. WhatsApp Business Account
2. Meta Developer Account
3. WhatsApp Business API App
4. Access to Meta Developer Console

## ğŸš€ Setup Steps

### Step 1: Generate Long-lived Refresh Token

1. **Get Short-lived Token**:
   - Go to [Meta Developer Console](https://developers.facebook.com/)
   - Navigate to your WhatsApp Business API app
   - Go to "WhatsApp" â†’ "API Setup"
   - Copy the "Temporary access token"

2. **Run Token Generator**:
   ```bash
   cd backend
   python generate_whatsapp_refresh_token.py
   ```

3. **Provide Credentials**:
   - App ID (from Meta Developer Console)
   - App Secret (from Meta Developer Console)
   - Short-lived Access Token (from step 1)

4. **Save Generated Values**:
   The script will output:
   ```
   WHATSAPP_APP_ID=your_app_id
   WHATSAPP_APP_SECRET=your_app_secret
   WHATSAPP_REFRESH_TOKEN=your_long_lived_token
   ```

### Step 2: Update Environment Variables

Add these to your AWS App Runner environment variables:

```bash
# Existing variables
WHATSAPP_PHONE_NUMBER_ID=626899147177664
WHATSAPP_BUSINESS_ACCOUNT_ID=your_business_account_id
WHATSAPP_WEBHOOK_VERIFY_TOKEN=your_verify_token
WHATSAPP_ACCESS_TOKEN=your_current_token

# New variables for automatic refresh
WHATSAPP_APP_ID=your_app_id
WHATSAPP_APP_SECRET=your_app_secret
WHATSAPP_REFRESH_TOKEN=your_long_lived_token
```

### Step 3: Deploy Updated Code

The enhanced WhatsApp service now includes:
- âœ… Automatic token refresh before expiration
- âœ… Retry mechanism on token expiry
- âœ… Background token monitoring
- âœ… Comprehensive error handling

### Step 4: Verify Setup

1. **Check Logs**:
   ```bash
   aws logs tail /aws/apprunner/neo-networker-backend-final/3f3d591c486b4865b677fe0a518ac976/application --follow
   ```

2. **Look for Messages**:
   - "WhatsApp access token refreshed successfully"
   - "WhatsApp token is expired or expiring soon, refreshing..."

3. **Test WhatsApp Messaging**:
   - Send a test message via the bot
   - Verify it works without manual token renewal

## ğŸ”§ How It Works

### Automatic Refresh Flow:
1. **Before Each Message**: Check if token expires in next 5 minutes
2. **If Expiring**: Automatically refresh using long-lived token
3. **On 401 Error**: Refresh token and retry message
4. **Background Monitoring**: Optional background task for proactive refresh

### Token Lifecycle:
- **Short-lived Token**: 1-2 hours (from Meta Console)
- **Long-lived Token**: 60 days (generated by script)
- **Refresh Token**: Used to generate new short-lived tokens
- **Automatic Refresh**: Happens before expiration

## ğŸ› ï¸ Advanced Configuration

### Background Scheduler (Optional)
For proactive token refresh, run the background scheduler:

```bash
# As a separate process
python token_refresh_scheduler.py

# Or integrate into main app
from token_refresh_scheduler import TokenRefreshScheduler
scheduler = TokenRefreshScheduler(refresh_interval_minutes=30)
scheduler.start()
```

### Custom Refresh Interval
Modify the refresh timing in `whatsapp_service.py`:

```python
# Check if token expires in the next X minutes
if self.token_expires_at and datetime.now() + timedelta(minutes=10) >= self.token_expires_at:
```

## ğŸ” Troubleshooting

### Common Issues:

1. **"Refresh token or App ID not configured"**:
   - Verify environment variables are set correctly
   - Check AWS App Runner environment variables

2. **"Failed to refresh WhatsApp token"**:
   - Verify App ID and App Secret are correct
   - Check if refresh token is still valid (60 days)
   - Ensure app has necessary permissions

3. **"WhatsApp token expired, attempting refresh"**:
   - This is normal behavior
   - Check if refresh was successful in logs

### Debug Commands:
```bash
# Check current environment variables
aws apprunner describe-service --service-arn your_service_arn

# View recent logs
aws logs tail /aws/apprunner/neo-networker-backend-final/3f3d591c486b4865b677fe0a518ac976/application --since 1h
```

## ğŸ“Š Monitoring

### Key Metrics to Monitor:
- Token refresh success rate
- Message delivery success rate
- Token expiration warnings
- Refresh token expiry (60 days)

### Log Patterns:
- âœ… `WhatsApp access token refreshed successfully`
- âš ï¸ `WhatsApp token is expired or expiring soon, refreshing...`
- âŒ `Failed to refresh WhatsApp token`

## ğŸ”„ Maintenance

### Every 60 Days:
1. Generate new long-lived refresh token
2. Update `WHATSAPP_REFRESH_TOKEN` environment variable
3. Redeploy or restart service

### Monthly Checks:
1. Verify token refresh is working
2. Check message delivery rates
3. Review error logs

## ğŸ¯ Benefits

- âœ… **No Manual Intervention**: Tokens refresh automatically
- âœ… **Zero Downtime**: Messages continue working
- âœ… **Proactive Refresh**: Tokens refreshed before expiration
- âœ… **Error Recovery**: Automatic retry on token expiry
- âœ… **Comprehensive Logging**: Full visibility into token lifecycle

## ğŸ“ Support

If you encounter issues:
1. Check the logs for specific error messages
2. Verify all environment variables are set
3. Test token generation script manually
4. Contact Meta Developer Support for API issues
